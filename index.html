<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amigo Oculto Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        header {
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            color: white;
            text-align: center;
            padding: 20px;
            flex-shrink: 0;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .section {
            padding: 25px;
            display: none;
            flex: 1;
            overflow-y: auto;
        }
        
        .active {
            display: flex;
            flex-direction: column;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            border-color: #6a11cb;
            outline: none;
        }
        
        button {
            background: linear-gradient(90deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            font-weight: 600;
            margin: 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, #feb47b, #ff7e5f);
        }
        
        .participants-list {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .participant-item {
            padding: 10px 15px;
            background-color: white;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .code-display {
            background-color: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
            font-size: 1.3rem;
            font-weight: bold;
            letter-spacing: 2px;
            color: #6a11cb;
        }
        
        .result-card {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .result-name {
            font-size: 1.8rem;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .instructions {
            background-color: #e9ecef;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            color: #6c757d;
            font-size: 0.9rem;
            border-top: 1px solid #dee2e6;
            flex-shrink: 0;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .button-group button {
            flex: 1;
            min-width: 180px;
        }
        
        /* Estilos do Chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 300px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        
        .message {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.own {
            background: linear-gradient(90deg, #6a11cb, #2575fc);
            color: white;
            margin-left: auto;
        }
        
        .message.other {
            background-color: white;
            border: 1px solid #ddd;
        }
        
        .message-sender {
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        
        .message-text {
            font-size: 0.9rem;
        }
        
        .chat-input {
            display: flex;
            padding: 10px;
            background-color: white;
            border-top: 1px solid #ddd;
        }
        
        .chat-input input {
            flex: 1;
            margin-right: 10px;
            padding: 10px;
        }
        
        .chat-input button {
            margin: 0;
            padding: 10px 15px;
        }
        
        .room-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100%;
        }
        
        .room-column {
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 768px) {
            .room-layout {
                grid-template-columns: 1fr;
            }
            
            .container {
                height: 95vh;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .section {
                padding: 15px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group button {
                width: 100%;
            }
            
            .chat-container {
                height: 250px;
            }
        }
        
        .password-note {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .login-options {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
        }
        
        .tab-button {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #e9ecef;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .tab-button.active {
            background-color: #6a11cb;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
    
    <!-- SDKs do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Amigo Oculto Premium</h1>
            <p class="subtitle">Com chat e login seguro!</p>
        </header>
        
        <main style="flex: 1; overflow-y: auto;">
            <!-- Se√ß√£o de Cria√ß√£o de Sala -->
            <section id="create-section" class="section active">
                <h2>Criar Nova Sala</h2>
                <div class="form-group">
                    <label for="host-name">Seu Nome (Anfitri√£o)</label>
                    <input type="text" id="host-name" placeholder="Digite seu nome">
                </div>
                <div class="form-group">
                    <label for="host-password">Sua Palavra-passe</label>
                    <input type="password" id="host-password" placeholder="Crie uma palavra-passe">
                    <div class="password-note">Guarde esta palavra-passe para retornar √† sala depois</div>
                </div>
                <div class="form-group">
                    <label for="room-name">Nome da Sala</label>
                    <input type="text" id="room-name" placeholder="Digite um nome para a sala">
                </div>
                <div class="button-group">
                    <button id="create-room-btn">Criar Sala</button>
                </div>
            </section>
            
            <!-- Se√ß√£o de Entrada na Sala -->
            <section id="join-section" class="section">
                <h2>Entrar em uma Sala</h2>
                
                <div class="login-options">
                    <div class="tab-buttons">
                        <button class="tab-button active" data-tab="new-user">Novo Participante</button>
                        <button class="tab-button" data-tab="returning-user">J√° Tenho Login</button>
                    </div>
                    
                    <!-- Novo Usu√°rio -->
                    <div id="new-user-tab" class="tab-content active">
                        <div class="form-group">
                            <label for="participant-name">Seu Nome</label>
                            <input type="text" id="participant-name" placeholder="Digite seu nome">
                        </div>
                        <div class="form-group">
                            <label for="participant-password">Criar Palavra-passe</label>
                            <input type="password" id="participant-password" placeholder="Crie sua palavra-passe">
                            <div class="password-note">Guarde esta palavra-passe para retornar √† sala</div>
                        </div>
                        <div class="form-group">
                            <label for="room-code">C√≥digo da Sala</label>
                            <input type="text" id="room-code" placeholder="Digite o c√≥digo da sala">
                        </div>
                    </div>
                    
                    <!-- Usu√°rio Retornando -->
                    <div id="returning-user-tab" class="tab-content">
                        <div class="form-group">
                            <label for="returning-name">Seu Nome</label>
                            <input type="text" id="returning-name" placeholder="Digite seu nome">
                        </div>
                        <div class="form-group">
                            <label for="returning-password">Sua Palavra-passe</label>
                            <input type="password" id="returning-password" placeholder="Digite sua palavra-passe">
                        </div>
                        <div class="form-group">
                            <label for="returning-room-code">C√≥digo da Sala</label>
                            <input type="text" id="returning-room-code" placeholder="Digite o c√≥digo da sala">
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="join-room-btn">Entrar na Sala</button>
                    <button class="btn-secondary" id="back-to-create">Voltar</button>
                </div>
            </section>
            
            <!-- Se√ß√£o da Sala -->
            <section id="room-section" class="section">
                <div class="room-layout">
                    <div class="room-column">
                        <h2>Sala: <span id="display-room-name"></span></h2>
                        <div class="code-display">
                            C√≥digo: <span id="display-room-code"></span>
                        </div>
                        
                        <h3>Participantes Online</h3>
                        <div class="participants-list" id="participants-list">
                            <!-- Lista de participantes ser√° gerada aqui -->
                        </div>
                        
                        <div id="host-controls">
                            <div class="button-group">
                                <button id="start-draw-btn">Realizar Sorteio</button>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn-secondary" id="leave-room">Sair da Sala</button>
                        </div>
                    </div>
                    
                    <div class="room-column">
                        <h3>Chat da Sala</h3>
                        <div class="chat-container">
                            <div class="chat-messages" id="chat-messages">
                                <!-- Mensagens do chat ser√£o exibidas aqui -->
                            </div>
                            <div class="chat-input">
                                <input type="text" id="chat-input" placeholder="Digite sua mensagem...">
                                <button id="send-message-btn"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Se√ß√£o de Resultados -->
            <section id="result-section" class="section">
                <h2>Resultado do Amigo Oculto</h2>
                <div class="result-card">
                    <p>Seu amigo oculto √©:</p>
                    <div class="result-name" id="drawn-friend"></div>
                    <p>Divirta-se com o jogo!</p>
                </div>
                
                <div class="instructions">
                    <p><strong>Instru√ß√µes:</strong> Mantenha em segredo quem voc√™ tirou. O anfitri√£o j√° foi notificado sobre todos os pares.</p>
                </div>
                
                <div class="button-group">
                    <button class="btn-secondary" id="back-to-room">Voltar para a Sala</button>
                </div>
            </section>
            
            <!-- Links de Navega√ß√£o Inicial -->
            <div id="initial-options" style="text-align: center; padding: 20px;">
                <p>J√° tem uma sala?</p>
                <div class="button-group">
                    <button id="join-existing-btn">Entrar em uma Sala Existente</button>
                </div>
            </div>
        </main>
        
        <footer>
            <p>Gota Games &copy; 2025 - Todos os direitos reservados</p>
        </footer>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDcfIkzxxwc7tbY9RXpOzQsGiqJ_NewdME",
            authDomain: "amigo-oculto-1e74b.firebaseapp.com",
            projectId: "amigo-oculto-1e74b",
            storageBucket: "amigo-oculto-1e74b.firebasestorage.app",
            messagingSenderId: "260384566404",
            appId: "1:260384566404:web:1b6c29d0099d68ff9d26d1"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', function() {
            // Elementos da interface
            const createSection = document.getElementById('create-section');
            const joinSection = document.getElementById('join-section');
            const roomSection = document.getElementById('room-section');
            const resultSection = document.getElementById('result-section');
            const initialOptions = document.getElementById('initial-options');
            
            // Bot√µes de navega√ß√£o
            const joinExistingBtn = document.getElementById('join-existing-btn');
            const createRoomBtn = document.getElementById('create-room-btn');
            const joinRoomBtn = document.getElementById('join-room-btn');
            const backToCreateBtn = document.getElementById('back-to-create');
            const leaveRoomBtn = document.getElementById('leave-room');
            const backToRoomBtn = document.getElementById('back-to-room');
            const startDrawBtn = document.getElementById('start-draw-btn');
            const sendMessageBtn = document.getElementById('send-message-btn');
            
            // Elementos de dados
            const hostNameInput = document.getElementById('host-name');
            const hostPasswordInput = document.getElementById('host-password');
            const roomNameInput = document.getElementById('room-name');
            const participantNameInput = document.getElementById('participant-name');
            const participantPasswordInput = document.getElementById('participant-password');
            const roomCodeInput = document.getElementById('room-code');
            const returningNameInput = document.getElementById('returning-name');
            const returningPasswordInput = document.getElementById('returning-password');
            const returningRoomCodeInput = document.getElementById('returning-room-code');
            const displayRoomName = document.getElementById('display-room-name');
            const displayRoomCode = document.getElementById('display-room-code');
            const participantsList = document.getElementById('participants-list');
            const drawnFriend = document.getElementById('drawn-friend');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');
            
            // Estado da aplica√ß√£o
            let currentRoom = null;
            let currentUser = null;
            let currentUserPassword = null;
            let isHost = false;
            let roomListener = null;
            let chatListener = null;
            let isReturningUser = false;

            // Sistema de abas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Atualizar bot√µes
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Atualizar conte√∫do
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                    
                    isReturningUser = (tabName === 'returning-user');
                });
            });

            // Navega√ß√£o
            joinExistingBtn.addEventListener('click', () => {
                createSection.classList.remove('active');
                joinSection.classList.add('active');
                initialOptions.style.display = 'none';
            });
            
            backToCreateBtn.addEventListener('click', () => {
                joinSection.classList.remove('active');
                createSection.classList.add('active');
                initialOptions.style.display = 'block';
            });
            
            // Criar sala
            createRoomBtn.addEventListener('click', async () => {
                const hostName = hostNameInput.value.trim();
                const hostPassword = hostPasswordInput.value.trim();
                const roomName = roomNameInput.value.trim();
                
                if (!hostName || !hostPassword || !roomName) {
                    alert('Por favor, preencha todos os campos.');
                    return;
                }
                
                const roomCode = generateRoomCode();
                
                try {
                    await db.collection('rooms').doc(roomCode).set({
                        name: roomName,
                        host: hostName,
                        participants: [hostName],
                        participantPasswords: { [hostName]: hostPassword },
                        drawnPairs: {},
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    currentUser = hostName;
                    currentUserPassword = hostPassword;
                    isHost = true;
                    currentRoom = roomCode;
                    
                    displayRoomName.textContent = roomName;
                    displayRoomCode.textContent = roomCode;
                    
                    setupRoomListener(roomCode);
                    setupChatListener(roomCode);
                    
                    createSection.classList.remove('active');
                    roomSection.classList.add('active');
                    initialOptions.style.display = 'none';
                    
                    document.getElementById('host-controls').style.display = 'block';
                } catch (error) {
                    console.error('Erro ao criar sala:', error);
                    alert('Erro ao criar sala. Tente novamente.');
                }
            });
            
            // Entrar na sala
            joinRoomBtn.addEventListener('click', async () => {
                let participantName, participantPassword, roomCode;
                
                if (isReturningUser) {
                    participantName = returningNameInput.value.trim();
                    participantPassword = returningPasswordInput.value.trim();
                    roomCode = returningRoomCodeInput.value.trim().toUpperCase();
                } else {
                    participantName = participantNameInput.value.trim();
                    participantPassword = participantPasswordInput.value.trim();
                    roomCode = roomCodeInput.value.trim().toUpperCase();
                }
                
                if (!participantName || !participantPassword || !roomCode) {
                    alert('Por favor, preencha todos os campos.');
                    return;
                }
                
                try {
                    const roomDoc = await db.collection('rooms').doc(roomCode).get();
                    
                    if (!roomDoc.exists) {
                        alert('Sala n√£o encontrada. Verifique o c√≥digo.');
                        return;
                    }
                    
                    const roomData = roomDoc.data();
                    
                    if (isReturningUser) {
                        // Verificar se o usu√°rio j√° existe com a senha correta
                        if (!roomData.participantPasswords || 
                            roomData.participantPasswords[participantName] !== participantPassword) {
                            alert('Nome ou palavra-passe incorretos.');
                            return;
                        }
                    } else {
                        // Novo usu√°rio - verificar se o nome j√° existe
                        if (roomData.participants.includes(participantName)) {
                            alert('J√° existe um participante com esse nome na sala.');
                            return;
                        }
                        
                        // Adicionar novo participante
                        await db.collection('rooms').doc(roomCode).update({
                            participants: firebase.firestore.FieldValue.arrayUnion(participantName),
                            [`participantPasswords.${participantName}`]: participantPassword
                        });
                    }
                    
                    currentUser = participantName;
                    currentUserPassword = participantPassword;
                    isHost = false;
                    currentRoom = roomCode;
                    
                    displayRoomName.textContent = roomData.name;
                    displayRoomCode.textContent = roomCode;
                    
                    setupRoomListener(roomCode);
                    setupChatListener(roomCode);
                    
                    joinSection.classList.remove('active');
                    roomSection.classList.add('active');
                    initialOptions.style.display = 'none';
                    
                    document.getElementById('host-controls').style.display = 'none';
                } catch (error) {
                    console.error('Erro ao entrar na sala:', error);
                    alert('Erro ao entrar na sala. Tente novamente.');
                }
            });
            
            // Sair da sala
            leaveRoomBtn.addEventListener('click', async () => {
                if (!currentRoom || !currentUser) return;
                
                try {
                    // Parar listeners
                    if (roomListener) roomListener();
                    if (chatListener) chatListener();
                    
                    // Limpar estado
                    currentRoom = null;
                    currentUser = null;
                    currentUserPassword = null;
                    isHost = false;
                    
                    // Voltar para tela inicial
                    roomSection.classList.remove('active');
                    createSection.classList.add('active');
                    initialOptions.style.display = 'block';
                    
                    // Limpar formul√°rios
                    hostNameInput.value = '';
                    hostPasswordInput.value = '';
                    roomNameInput.value = '';
                    participantNameInput.value = '';
                    participantPasswordInput.value = '';
                    roomCodeInput.value = '';
                    returningNameInput.value = '';
                    returningPasswordInput.value = '';
                    returningRoomCodeInput.value = '';
                } catch (error) {
                    console.error('Erro ao sair da sala:', error);
                    alert('Erro ao sair da sala. Tente novamente.');
                }
            });
            
            // Sorteio
            startDrawBtn.addEventListener('click', async () => {
                if (!currentRoom) return;
                
                try {
                    const roomDoc = await db.collection('rooms').doc(currentRoom).get();
                    
                    if (!roomDoc.exists) {
                        alert('Sala n√£o encontrada.');
                        return;
                    }
                    
                    const roomData = roomDoc.data();
                    
                    if (roomData.participants.length < 2) {
                        alert('√â necess√°rio pelo menos 2 participantes para realizar o sorteio.');
                        return;
                    }
                    
                    const drawResult = performDraw(roomData.participants);
                    
                    await db.collection('rooms').doc(currentRoom).update({
                        drawnPairs: drawResult
                    });
                    
                    if (isHost) {
                        let resultMessage = "Resultado do sorteio:\n\n";
                        for (const [giver, receiver] of Object.entries(drawResult)) {
                            resultMessage += `${giver} tirou ${receiver}\n`;
                        }
                        alert(resultMessage);
                    }
                    
                    drawnFriend.textContent = drawResult[currentUser];
                    roomSection.classList.remove('active');
                    resultSection.classList.add('active');
                } catch (error) {
                    console.error('Erro ao realizar sorteio:', error);
                    alert('Erro ao realizar sorteio. Tente novamente.');
                }
            });
            
            // Enviar mensagem no chat
            sendMessageBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            function sendMessage() {
              const messageText = chatInput.value.trim();
    
              // Verifica√ß√£o mais robusta
              if (!messageText) {
              alert('Digite uma mensagem!');
              return;
              }
              if (!currentRoom || !currentUser) {
              alert('Voc√™ precisa estar em uma sala para enviar mensagens!');
              return;
              }
    
    console.log('Enviando mensagem para sala:', currentRoom);
    
    // Adicionar tratamento de erro
    db.collection('rooms').doc(currentRoom).collection('messages').add({
        sender: currentUser,
        text: messageText,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        console.log('‚úÖ Mensagem enviada com sucesso!');
        chatInput.value = ''; // Limpa s√≥ se enviar com sucesso
    }).catch((error) => {
        console.error('‚ùå Erro ao enviar mensagem:', error);
        alert('Erro ao enviar mensagem: ' + error.message);
    });
}
            
            // Listener da sala
            function setupRoomListener(roomCode) {
                if (roomListener) roomListener();
                
                roomListener = db.collection('rooms').doc(roomCode)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const roomData = doc.data();
                            updateParticipantsList(roomData.participants, roomData.host);
                            
                            if (roomData.drawnPairs && roomData.drawnPairs[currentUser] && 
                                roomSection.classList.contains('active')) {
                                drawnFriend.textContent = roomData.drawnPairs[currentUser];
                                roomSection.classList.remove('active');
                                resultSection.classList.add('active');
                            }
                        } else {
                            alert('Esta sala foi exclu√≠da pelo anfitri√£o.');
                            leaveRoomBtn.click();
                        }
                    });
            }
            
            // Listener do chat
            function setupChatListener(roomCode) {
               // Parar listener anterior
               if (chatListener) {
                  chatListener();
                  console.log('üîÑ Parando listener anterior do chat');
                }
    
               console.log('üéØ Iniciando novo listener para sala:', roomCode);
    
               // Configurar novo listener com tratamento de erro
               chatListener = db.collection('rooms').doc(roomCode)
                  .collection('messages')
                  .orderBy('timestamp', 'asc')
                  .onSnapshot((snapshot) => {
               console.log('üì® Recebidas', snapshot.size, 'mensagens');
            
               // Limpar chat
               chatMessages.innerHTML = '';
            
                // Verificar se h√° mensagens
               if (snapshot.empty) {
                   console.log('üí¨ Chat vazio');
                   const emptyMsg = document.createElement('div');
                   emptyMsg.textContent = 'Nenhuma mensagem ainda. Seja o primeiro a escrever!';
                   emptyMsg.style.textAlign = 'center';
                   emptyMsg.style.color = '#666';
                   emptyMsg.style.padding = '20px';
                   chatMessages.appendChild(emptyMsg);
                   return;
               }
            
               // Processar cada mensagem
               snapshot.forEach(doc => {
                   const message = doc.data();
                   console.log('üí¨ Mensagem:', message);
                   displayMessage(message.sender, message.text, message.timestamp);
               });
            
               // Scroll autom√°tico para a √∫ltima mensagem
               setTimeout(() => {
                   chatMessages.scrollTop = chatMessages.scrollHeight;
               }, 100);
            
            }, (error) => {
                // Tratamento de erro IMPORTANTE
                console.error('‚ùå Erro no listener do chat:', error);
                alert('Erro ao conectar ao chat: ' + error.message);
                });
             }
            
            // Exibir mensagem no chat
            function displayMessage(sender, text, timestamp) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender === currentUser ? 'own' : 'other'}`;
                
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                senderDiv.textContent = sender === currentUser ? 'Voc√™' : sender;
                
                const textDiv = document.createElement('div');
                textDiv.className = 'message-text';
                textDiv.textContent = text;
                
                messageDiv.appendChild(senderDiv);
                messageDiv.appendChild(textDiv);
                chatMessages.appendChild(messageDiv);
            }
            
            // Atualizar lista de participantes
            function updateParticipantsList(participants, host) {
                participantsList.innerHTML = '';
                participants.forEach(participant => {
                    const participantItem = document.createElement('div');
                    participantItem.className = 'participant-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = participant;
                    
                    const roleSpan = document.createElement('span');
                    if (participant === host) {
                        roleSpan.textContent = 'Anfitri√£o';
                        roleSpan.style.color = '#6a11cb';
                        roleSpan.style.fontWeight = 'bold';
                    }
                    
                    participantItem.appendChild(nameSpan);
                    participantItem.appendChild(roleSpan);
                    participantsList.appendChild(participantItem);
                });
            }
            
            backToRoomBtn.addEventListener('click', () => {
                resultSection.classList.remove('active');
                roomSection.classList.add('active');
            });
            
            function generateRoomCode() {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < 6; i++) {
                    result += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                return result;
            }
            
            function performDraw(participants) {
                const receivers = [...participants];
                const result = {};
                
                for (let i = receivers.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [receivers[i], receivers[j]] = [receivers[j], receivers[i]];
                }
                
                for (let i = 0; i < participants.length; i++) {
                    let giver = participants[i];
                    let receiver = receivers[i];
                    
                    if (giver === receiver) {
                        const nextIndex = (i + 1) % participants.length;
                        receivers[i] = receivers[nextIndex];
                        receivers[nextIndex] = receiver;
                        receiver = receivers[i];
                    }
                    
                    result[giver] = receiver;
                }
                
                return result;
            }
        });
    </script>
</body>
</html>